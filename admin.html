<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin — Aayush Parashar</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <style>
        :root {
            --bg: #0a0a0a;
            --bg-card: #111111;
            --border: #1f1f1f;
            --green: #10b981;
            --green-dim: rgba(16, 185, 129, 0.1);
            --text: #e5e5e5;
            --text-muted: #6b7280;
            --red: #ef4444;
            --yellow: #f59e0b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }

        /* ---- LOGIN ---- */
        #login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
        }

        .login-box h1 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.2rem;
            color: var(--green);
            margin-bottom: 8px;
        }

        .login-box p {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 32px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 8px;
            font-family: 'JetBrains Mono', monospace;
        }

        input, textarea, select {
            width: 100%;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px 16px;
            color: var(--text);
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            transition: border-color 0.2s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--green);
        }

        .btn {
            width: 100%;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s, transform 0.1s;
        }

        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-primary {
            background: var(--green);
            color: #000;
        }

        .btn-primary:hover:not(:disabled) { opacity: 0.9; }

        .btn-danger {
            background: transparent;
            color: var(--red);
            border: 1px solid var(--red);
        }

        .btn-sm {
            width: auto;
            padding: 6px 14px;
            font-size: 0.82rem;
        }

        .error-msg {
            color: var(--red);
            font-size: 0.85rem;
            margin-top: 12px;
            display: none;
        }

        /* ---- DASHBOARD ---- */
        #dashboard { display: none; }

        .top-bar {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 16px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .top-bar h1 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            color: var(--green);
        }

        .top-bar-actions { display: flex; gap: 12px; align-items: center; }

        .top-bar-actions a {
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.85rem;
        }

        .top-bar-actions a:hover { color: var(--text); }

        .dashboard-content {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 24px;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .section-header h2 {
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* ---- POST EDITOR ---- */
        .editor-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 28px;
            margin-bottom: 40px;
        }

        .editor-card h2 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            color: var(--green);
            margin-bottom: 24px;
        }

        textarea {
            resize: vertical;
            min-height: 180px;
            line-height: 1.6;
        }

        .editor-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .editor-footer {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-top: 20px;
        }

        .toggle-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .toggle-label input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--green);
        }

        /* ---- POSTS LIST ---- */
        .post-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 18px 22px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }

        .post-item-info h3 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .post-item-meta {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .post-item-meta span {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-family: 'JetBrains Mono', monospace;
        }

        .badge-published { background: rgba(16, 185, 129, 0.15); color: var(--green); }
        .badge-draft { background: rgba(245, 158, 11, 0.15); color: var(--yellow); }

        .post-actions { display: flex; gap: 8px; flex-shrink: 0; }

        .empty-state {
            text-align: center;
            padding: 48px 0;
            color: var(--text-muted);
        }

        .empty-state p { margin-top: 8px; font-size: 0.9rem; }

        @media (max-width: 600px) {
            .editor-row { grid-template-columns: 1fr; }
            .post-item { flex-direction: column; align-items: flex-start; }
            .top-bar { padding: 16px; }
        }
    </style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="login-screen">
    <div class="login-box">
        <h1>~/admin $ ./login</h1>
        <p>Access restricted to authorized user only.</p>
        <div class="form-group">
            <label>USERNAME</label>
            <input type="text" id="login-username" placeholder="username" autocomplete="username">
        </div>
        <div class="form-group">
            <label>PASSWORD</label>
            <input type="password" id="login-password" placeholder="••••••••" autocomplete="current-password">
        </div>
        <button class="btn btn-primary" id="login-btn">Login</button>
        <p class="error-msg" id="login-error"></p>
    </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard">
    <div class="top-bar">
        <h1>~/admin $ dashboard</h1>
        <div class="top-bar-actions">
            <a href="posts.html" target="_blank">↗ View Blog</a>
            <a href="index.html">↗ Portfolio</a>
            <button class="btn btn-sm" style="border:1px solid var(--border); background:transparent; color:var(--text-muted)" id="change-password-btn">Change Password</button>
            <button class="btn btn-danger btn-sm" id="logout-btn">Logout</button>
        </div>
    </div>

    <div class="dashboard-content">
        <!-- Editor -->
        <div class="editor-card">
            <h2 id="editor-title">// New Post</h2>
            <input type="hidden" id="edit-id">
            <div class="form-group">
                <label>TITLE</label>
                <input type="text" id="post-title" placeholder="Post title...">
            </div>
            <div class="form-group">
                <label>CONTENT (Markdown supported)</label>
                <textarea id="post-content" placeholder="Write your post here..."></textarea>
            </div>
            <div class="editor-row">
                <div class="form-group">
                    <label>CATEGORY</label>
                    <select id="post-category">
                        <option>Update</option>
                        <option>Tech</option>
                        <option>Research</option>
                        <option>Trading</option>
                        <option>Life</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>TAGS (comma separated)</label>
                    <input type="text" id="post-tags" placeholder="e.g. C++, Systems, HFT">
                </div>
            </div>
            <div class="editor-footer">
                <button class="btn btn-primary btn-sm" id="save-btn">Publish</button>
                <button class="btn btn-sm" id="draft-btn" style="border:1px solid var(--border); background:transparent; color:var(--text-muted)">Save Draft</button>
                <button class="btn btn-sm" id="cancel-btn" style="display:none; border:1px solid var(--border); background:transparent; color:var(--text-muted)">Cancel</button>
                <label class="toggle-label">
                    <input type="checkbox" id="post-published"> Publish immediately
                </label>
            </div>
            <p class="error-msg" id="save-error"></p>
        </div>

        <!-- Posts List -->
        <div class="section-header">
            <h2>All Posts</h2>
            <span id="posts-count" style="font-size:0.85rem; color:var(--text-muted); font-family:'JetBrains Mono',monospace;"></span>
        </div>
        <div id="posts-list"></div>
    </div>

    <!-- Password Change Modal -->
    <div id="password-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; display:none; align-items:center; justify-content:center;">
        <div style="background:var(--bg-card); border:1px solid var(--border); border-radius:16px; padding:32px; max-width:400px; width:90%;">
            <h2 style="font-family:'JetBrains Mono',monospace; font-size:1rem; color:var(--green); margin-bottom:24px;">Change Password</h2>
            <div class="form-group">
                <label>CURRENT PASSWORD</label>
                <input type="password" id="current-password" placeholder="••••••••">
            </div>
            <div class="form-group">
                <label>NEW PASSWORD</label>
                <input type="password" id="new-password" placeholder="••••••••">
            </div>
            <div class="form-group">
                <label>CONFIRM NEW PASSWORD</label>
                <input type="password" id="confirm-password" placeholder="••••••••">
            </div>
            <p class="error-msg" id="password-error"></p>
            <div style="display:flex; gap:12px; margin-top:20px;">
                <button class="btn btn-primary btn-sm" id="save-password-btn">Save</button>
                <button class="btn btn-sm" style="border:1px solid var(--border); background:transparent; color:var(--text-muted)" id="cancel-password-btn">Cancel</button>
            </div>
        </div>
    </div>
</div>

<script>
    const API = 'http://localhost:3000/api';
    let token = localStorage.getItem('cms_token');

    // ---- AUTH ----
    function checkAuth() {
        if (token) showDashboard();
    }

    document.getElementById('login-btn').addEventListener('click', async () => {
        const btn = document.getElementById('login-btn');
        const errEl = document.getElementById('login-error');
        const username = document.getElementById('login-username').value.trim();
        const password = document.getElementById('login-password').value;

        if (!username || !password) {
            showError(errEl, 'Please enter username and password');
            return;
        }

        btn.disabled = true;
        btn.textContent = 'Logging in...';
        errEl.style.display = 'none';

        try {
            const res = await fetch(`${API}/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            const data = await res.json();

            if (!res.ok) throw new Error(data.error || 'Login failed');

            token = data.token;
            localStorage.setItem('cms_token', token);
            showDashboard();
        } catch (err) {
            showError(errEl, err.message);
        } finally {
            btn.disabled = false;
            btn.textContent = 'Login';
        }
    });

    document.getElementById('login-password').addEventListener('keydown', e => {
        if (e.key === 'Enter') document.getElementById('login-btn').click();
    });

    document.getElementById('logout-btn').addEventListener('click', () => {
        localStorage.removeItem('cms_token');
        token = null;
        document.getElementById('dashboard').style.display = 'none';
        document.getElementById('login-screen').style.display = 'flex';
    });

    function showDashboard() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        loadPosts();
    }

    // ---- POSTS ----
    async function loadPosts() {
        try {
            const res = await fetch(`${API}/posts/all`, {
                headers: { Authorization: `Bearer ${token}` }
            });
            if (res.status === 401) { logout(); return; }
            const posts = await res.json();
            renderPosts(posts);
        } catch {
            document.getElementById('posts-list').innerHTML = '<p style="color:var(--red)">Failed to load posts. Is the backend running?</p>';
        }
    }

    function renderPosts(posts) {
        const container = document.getElementById('posts-list');
        document.getElementById('posts-count').textContent = `${posts.length} post${posts.length !== 1 ? 's' : ''}`;

        if (posts.length === 0) {
            container.innerHTML = '<div class="empty-state"><h3>No posts yet</h3><p>Write your first post above!</p></div>';
            return;
        }

        container.innerHTML = posts.map(post => `
            <div class="post-item">
                <div class="post-item-info">
                    <h3>${escapeHtml(post.title)}</h3>
                    <div class="post-item-meta">
                        <span class="badge ${post.published ? 'badge-published' : 'badge-draft'}">${post.published ? 'Published' : 'Draft'}</span>
                        <span>${post.category}</span>
                        <span>${formatDate(post.createdAt)}</span>
                    </div>
                </div>
                <div class="post-actions">
                    <button class="btn btn-sm" style="border:1px solid var(--border); background:transparent; color:var(--text-muted)" onclick="editPost('${post._id}')">Edit</button>
                    <button class="btn btn-danger btn-sm" onclick="deletePost('${post._id}')">Delete</button>
                </div>
            </div>
        `).join('');
    }

    // Save post
    document.getElementById('save-btn').addEventListener('click', () => savePost(true));
    document.getElementById('draft-btn').addEventListener('click', () => savePost(false));

    async function savePost(publish) {
        const errEl = document.getElementById('save-error');
        const title = document.getElementById('post-title').value.trim();
        const content = document.getElementById('post-content').value.trim();
        const category = document.getElementById('post-category').value;
        const tagsRaw = document.getElementById('post-tags').value;
        const tags = tagsRaw.split(',').map(t => t.trim()).filter(Boolean);
        const editId = document.getElementById('edit-id').value;

        if (!title || !content) {
            showError(errEl, 'Title and content are required');
            return;
        }

        const body = { title, content, category, tags, published: publish };
        const url = editId ? `${API}/posts/${editId}` : `${API}/posts`;
        const method = editId ? 'PUT' : 'POST';

        try {
            const res = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                body: JSON.stringify(body)
            });
            if (res.status === 401) { logout(); return; }
            if (!res.ok) throw new Error((await res.json()).error);

            clearEditor();
            loadPosts();
        } catch (err) {
            showError(errEl, err.message);
        }
    }

    // Edit post
    async function editPost(id) {
        try {
            const res = await fetch(`${API}/posts/all`, { headers: { Authorization: `Bearer ${token}` } });
            const posts = await res.json();
            const post = posts.find(p => p._id === id);
            if (!post) return;

            document.getElementById('edit-id').value = post._id;
            document.getElementById('post-title').value = post.title;
            document.getElementById('post-content').value = post.content;
            document.getElementById('post-category').value = post.category;
            document.getElementById('post-tags').value = post.tags.join(', ');
            document.getElementById('post-published').checked = post.published;
            document.getElementById('editor-title').textContent = '// Edit Post';
            document.getElementById('cancel-btn').style.display = 'inline-block';

            document.querySelector('.editor-card').scrollIntoView({ behavior: 'smooth' });
        } catch {}
    }

    document.getElementById('cancel-btn').addEventListener('click', clearEditor);

    function clearEditor() {
        document.getElementById('edit-id').value = '';
        document.getElementById('post-title').value = '';
        document.getElementById('post-content').value = '';
        document.getElementById('post-category').value = 'Update';
        document.getElementById('post-tags').value = '';
        document.getElementById('post-published').checked = false;
        document.getElementById('editor-title').textContent = '// New Post';
        document.getElementById('cancel-btn').style.display = 'none';
        document.getElementById('save-error').style.display = 'none';
    }

    // Delete post
    async function deletePost(id) {
        if (!confirm('Delete this post?')) return;
        try {
            const res = await fetch(`${API}/posts/${id}`, {
                method: 'DELETE',
                headers: { Authorization: `Bearer ${token}` }
            });
            if (!res.ok) throw new Error('Delete failed');
            loadPosts();
        } catch (err) {
            alert(err.message);
        }
    }

    // ---- HELPERS ----
    function showError(el, msg) {
        el.textContent = msg;
        el.style.display = 'block';
    }

    function escapeHtml(s) {
        return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function formatDate(d) {
        return new Date(d).toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric' });
    }

    // ---- PASSWORD CHANGE ----
    const passwordModal = document.getElementById('password-modal');
    document.getElementById('change-password-btn').addEventListener('click', () => {
        passwordModal.style.display = 'flex';
        document.getElementById('current-password').value = '';
        document.getElementById('new-password').value = '';
        document.getElementById('confirm-password').value = '';
        document.getElementById('password-error').style.display = 'none';
    });

    document.getElementById('cancel-password-btn').addEventListener('click', () => {
        passwordModal.style.display = 'none';
    });

    document.getElementById('save-password-btn').addEventListener('click', async () => {
        const errEl = document.getElementById('password-error');
        const current = document.getElementById('current-password').value;
        const newPass = document.getElementById('new-password').value;
        const confirm = document.getElementById('confirm-password').value;

        if (!current || !newPass || !confirm) {
            showError(errEl, 'All fields required');
            return;
        }

        if (newPass !== confirm) {
            showError(errEl, 'New passwords do not match');
            return;
        }

        if (newPass.length < 8) {
            showError(errEl, 'Password must be at least 8 characters');
            return;
        }

        try {
            const res = await fetch(`${API}/change-password`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                body: JSON.stringify({ currentPassword: current, newPassword: newPass })
            });
            const data = await res.json();

            if (!res.ok) throw new Error(data.error);

            alert('Password changed successfully!');
            passwordModal.style.display = 'none';
        } catch (err) {
            showError(errEl, err.message);
        }
    });

    checkAuth();
</script>
</body>
</html>
